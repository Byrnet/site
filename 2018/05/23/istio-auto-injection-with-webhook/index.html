<!doctype html><html lang=ru><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Аудит проектной документации, оптимизация строительных решений и техническое обследование зданий. Экономим до 30% бюджета без потери качества."><title>Istio Sidecar自动注入原理 - Audit & Project - Оптимизация строительства</title><link rel=stylesheet href=/css/style.css><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;line-height:1.6;color:#000;background:#fff}.container{max-width:1200px;margin:0 auto;padding:0 20px}header{background:#fff;color:#000;padding:20px 0;margin-bottom:30px;box-shadow:0 2px 5px rgba(0,0,0,.1)}header .logo{font-size:24px;font-weight:700;margin-bottom:15px}header nav{display:flex;justify-content:center;align-items:center;flex-wrap:wrap;gap:10px}header nav button{color:#000;text-decoration:none;font-weight:700;transition:opacity .3s;border:1px solid #000;background:#fff;padding:8px 12px;cursor:pointer}header nav button:hover{opacity:.8;text-decoration:underline}main{min-height:70vh;margin-bottom:40px}article{background:#fff;padding:30px;border:1px solid #e0e0e0;border-radius:8px;margin-bottom:20px}article h1{color:#333;margin-bottom:20px}article h2{color:#333;margin-top:25px;margin-bottom:15px}article h3{color:#333;margin-top:20px;margin-bottom:10px}article ul,article ol{margin-left:20px;margin-bottom:15px}article li{margin-bottom:8px}article p{margin-bottom:15px}footer{background:#f5f5f5;color:#000;padding:20px 0;text-align:center;margin-top:40px;border-top:1px solid #ddd}</style></head><body><div class=container><header><div class=logo>Audit & Project - Оптимизация строительства</div><nav></nav></header><main id=main><article><h1>Istio Sidecar自动注入原理</h1><div class=post-meta><time datetime=2018-05-23>23.05.2018</time></div><div class=content><h2 id=前言>前言</h2><hr><p>Kubernets 1.9版本引入了Admission Webhook(web 回调)扩展机制，通过Webhook,开发者可以非常灵活地对Kubernets API Server的功能进行扩展，在API Server创建资源时对资源进行验证或者修改。</p><p>使用webhook的优势是不需要对API Server的源码进行修改和重新编译就可以扩展其功能。插入的逻辑实现为一个独立的web进程，通过参数方式传入到kubernets中，由kubernets在进行自身逻辑处理时对扩展逻辑进行回调。</p><p>Istio 0.7版本就利用了Kubernets webhook实现了sidecar的自动注入。</p><h2 id=什么是admission>什么是Admission</h2><hr><p>Admission是Kubernets中的一个术语，指的是Kubernets API Server资源请求过程中的一个阶段。如下图所示，在API Server接收到资源创建请求时，首先会对请求进行认证和鉴权，然后经过Admission处理，最后再保存到etcd。
<img src=/img/2018-4-25-istio-auto-injection-with-webhook/admission-phase.png alt>
从图中看到，Admission中有两个重要的阶段，Mutation和Validation，这两个阶段中执行的逻辑如下：</p><ul><li><p>Mutation</p><p>Mutation是英文“突变”的意思,从字面上可以知道在Mutation阶段可以对请求内容进行修改。</p></li><li><p>Validation</p><p>在Validation阶段不允许修改请求内容，但可以根据请求的内容判断是继续执行该请求还是拒绝该请求。</p></li></ul><h2 id=admission-webhook>Admission webhook</h2><hr><p>通过Admission webhook,可以加入Mutation和Validation两种类型的webhook插件，这些插件和Kubernets提供的预编译的Admission插件具有相同的能力。可以想到的用途包括：</p><ul><li>修改资源。例如Istio就通过Admin Webhook在Pod资源中增加了Envoy sidecar容器。</li><li>自定义校验逻辑，例如对资源名称有一些特殊要求。或者对自定义资源的合法性进行校验。</li></ul><h2 id=采用webhook自动注入istio-sidecar>采用Webhook自动注入Istio Sidecar</h2><hr><h3 id=kubernets版本要求>Kubernets版本要求</h3><p>webhook支持需要Kubernets1.9或者更高的版本,使用下面的命令确认kube-apiserver的Admin webhook功能已启用。</p><pre tabindex=0><code>kubectl api-versions | grep admissionregistration

admissionregistration.k8s.io/v1beta1
</code></pre><h3 id=生成sidecar-injection-webhook的密钥和证书>生成sidecar injection webhook的密钥和证书</h3><p>Webhook使用数字证书向kube-apiserver进行身份认证，因此需要先使用工具生成密钥对，并向Istio CA申请数字证书。</p><pre tabindex=0><code>./install/kubernetes/webhook-create-signed-cert.sh /
    --service istio-sidecar-injector /
    --namespace istio-system /
    --secret sidecar-injector-certs
</code></pre><h3 id=将生成的数字证书配置到webhook中>将生成的数字证书配置到webhook中</h3><pre tabindex=0><code>cat install/kubernetes/istio-sidecar-injector.yaml | /
     ./install/kubernetes/webhook-patch-ca-bundle.sh &gt; /
     install/kubernetes/istio-sidecar-injector-with-ca-bundle.yaml
</code></pre><h3 id=创建sidecar-injection-configmap>创建sidecar injection configmap</h3><pre tabindex=0><code>kubectl apply -f install/kubernetes/istio-sidecar-injector-configmap-release.yaml
</code></pre><h3 id=部署sidecar-injection-webhook>部署sidecar injection webhook</h3><pre tabindex=0><code>kubectl apply -f install/kubernetes/istio-sidecar-injector-with-ca-bundle.yaml
</code></pre><p>通过命令查看部署好的webhook injector</p><pre tabindex=0><code>kubectl -n istio-system get deployment -listio=sidecar-injector
Copy
NAME                     DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
istio-sidecar-injector   1         1         1            1           1d
```

### 开启需要自动注入sidecar的namespace 

```
kubectl label namespace default istio-injection=enabled

kubectl get namespace -L istio-injection

NAME           STATUS    AGE       ISTIO-INJECTION
default        Active    1h        enabled
istio-system   Active    1h        
kube-public    Active    1h        
kube-system    Active    1h  
```

## 参考

* [Extensible Admission is Beta](https://kubernetes.io/blog/2018/01/extensible-admission-is-beta)
* [Installing the Istio Sidecar](https://istio.io/docs/setup/kubernetes/sidecar-injection.html)
</code></pre></div></article></main><footer><p>&copy; 2025 Audit & Project - Оптимизация строительства. Все права защищены.</p><p>|</p></footer></div><script>function scrollToSection(e){const n={"введение":"intro","услуги":"services","процесс":"process","кейсы":"cases","о компании":"about","контакты":"contact"},s=n[e]||e,t=document.getElementById(s);t&&t.scrollIntoView({behavior:"smooth"})}</script></body></html>